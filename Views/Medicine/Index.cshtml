@model IEnumerable<Medicine>

@{
    ViewData["Title"] = "İlaç Yönetimi";
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-pills text-success"></i>
                İlaç Yönetimi
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")">Dashboard</a></li>
                    <li class="breadcrumb-item active">İlaçlar</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2">
            @{
                var userRole = Context.Session.GetString("UserRole");
            }
            
            @if (userRole == "Admin" || userRole == "Doctor")
            {
                <a href="@Url.Action("Create")" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Yeni İlaç Ekle
                </a>
            }
            
            <button class="btn btn-info" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Excel'e Aktar
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-gradient-primary text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Toplam İlaç</h6>
                            <h3 class="mb-0">@Model.Count()</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-pills fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-gradient-warning text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Düşük Stok</h6>
                            <h3 class="mb-0">@Model.Count(m => m.StockQuantity <= 10)</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-gradient-danger text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Stok Tükenen</h6>
                            <h3 class="mb-0">@Model.Count(m => m.StockQuantity == 0)</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-times-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-gradient-success text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-white-50">Toplam Stok</h6>
                            <h3 class="mb-0">@Model.Sum(m => m.StockQuantity)</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-boxes fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">İlaç Ara</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="İlaç adı ile ara...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Stok Durumu</label>
                    <select class="form-select" id="stockFilter">
                        <option value="">Tümü</option>
                        <option value="normal">Normal Stok</option>
                        <option value="low">Düşük Stok (≤10)</option>
                        <option value="empty">Stok Tükenen</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Sıralama</label>
                    <select class="form-select" id="sortSelect">
                        <option value="name-asc">İsim (A-Z)</option>
                        <option value="name-desc">İsim (Z-A)</option>
                        <option value="stock-asc">Stok (Az-Çok)</option>
                        <option value="stock-desc">Stok (Çok-Az)</option>
                        <option value="date-desc">En Yeni</option>
                        <option value="date-asc">En Eski</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-eraser"></i> Temizle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Medicine List -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> İlaç Listesi
                <span class="badge bg-secondary ms-2" id="totalCount">@Model.Count() İlaç</span>
            </h5>
        </div>
        
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="medicinesTable">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <i class="fas fa-pills"></i> İlaç Adı
                                </th>
                                <th>
                                    <i class="fas fa-flask"></i> Açıklama
                                </th>
                                <th class="text-center">
                                    <i class="fas fa-boxes"></i> Stok Miktarı
                                </th>
                                <th class="text-center">
                                    <i class="fas fa-calendar"></i> Eklenme Tarihi
                                </th>
                                <th class="text-center">
                                    <i class="fas fa-calendar-edit"></i> Güncellenme
                                </th>
                                <th class="text-center">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var medicine in Model.OrderBy(m => m.Name))
                            {
                                <tr class="medicine-row" data-name="@medicine.Name.ToLower()" data-stock="@medicine.StockQuantity" data-date="@medicine.CreatedAt.ToString("yyyy-MM-dd")">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                @if (medicine.StockQuantity == 0)
                                                {
                                                    <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                        <i class="fas fa-times text-white"></i>
                                                    </div>
                                                }
                                                else if (medicine.StockQuantity <= 10)
                                                {
                                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                        <i class="fas fa-exclamation text-white"></i>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                        <i class="fas fa-pills text-white"></i>
                                                    </div>
                                                }
                                            </div>
                                            <div>
                                                <h6 class="mb-0 fw-semibold">@medicine.Name</h6>
                                                @if (medicine.StockQuantity <= 10)
                                                {
                                                    @if (medicine.StockQuantity == 0)
                                                    {
                                                        <span class="badge bg-danger text-white small">
                                                            <i class="fas fa-times"></i> Stok Tükendi
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning text-dark small">
                                                            <i class="fas fa-exclamation-triangle"></i> Düşük Stok
                                                        </span>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-muted">@(string.IsNullOrEmpty(medicine.Description) ? "Açıklama bulunmuyor" : medicine.Description)</span>
                                    </td>
                                    <td class="text-center">
                                        @if (medicine.StockQuantity == 0)
                                        {
                                            <span class="badge bg-danger fs-6">0</span>
                                        }
                                        else if (medicine.StockQuantity <= 10)
                                        {
                                            <span class="badge bg-warning text-dark fs-6">@medicine.StockQuantity</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success fs-6">@medicine.StockQuantity</span>
                                        }
                                    </td>
                                    <td class="text-center text-muted">
                                        <small>
                                            <i class="fas fa-calendar"></i>
                                            @medicine.CreatedAt.ToString("dd/MM/yyyy")
                                            <br>
                                            <i class="fas fa-clock"></i>
                                            @medicine.CreatedAt.ToString("HH:mm")
                                        </small>
                                    </td>
                                    <td class="text-center text-muted">
                                        <small>
                                            @if (medicine.UpdatedAt.HasValue)
                                            {
                                                <i class="fas fa-calendar-edit"></i>
                                                @medicine.UpdatedAt.Value.ToString("dd/MM/yyyy")
                                                <br>
                                                <i class="fas fa-clock"></i>
                                                @medicine.UpdatedAt.Value.ToString("HH:mm")
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="@Url.Action("Details", new { id = medicine.Id })" 
                                               class="btn btn-outline-info btn-sm" 
                                               title="Detayları Görüntüle">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            @if (userRole == "Nurse")
                                            {
                                                @if (medicine.StockQuantity > 0)
                                                {
                                                    <button type="button" 
                                                            class="btn btn-outline-success btn-sm" 
                                                            onclick="useMedicine('@medicine.Id', '@medicine.Name')"
                                                            title="İlacı Kullan">
                                                        <i class="fas fa-hand-holding-medical"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button type="button" 
                                                            class="btn btn-outline-secondary btn-sm" 
                                                            disabled
                                                            title="Stok Tükendi">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                }
                                            }
                                            else if (userRole == "Admin" || userRole == "Doctor")
                                            {
                                                <a href="@Url.Action("Edit", new { id = medicine.Id })" 
                                                   class="btn btn-outline-primary btn-sm" 
                                                   title="Düzenle">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                
                                                @if (userRole == "Admin")
                                                {
                                                    <button type="button" 
                                                            class="btn btn-outline-danger btn-sm" 
                                                            onclick="confirmDelete('@medicine.Id', '@medicine.Name')"
                                                            title="Sil">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                }
                                                
                                                @if (medicine.StockQuantity > 0)
                                                {
                                                    <button type="button" 
                                                            class="btn btn-outline-success btn-sm" 
                                                            onclick="useMedicine('@medicine.Id', '@medicine.Name')"
                                                            title="İlacı Kullan">
                                                        <i class="fas fa-hand-holding-medical"></i>
                                                    </button>
                                                }
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center p-3 pt-2">
                    <div class="small text-muted">Sayfa Boyutu: 10 (maksimum)</div>
                    <nav><ul class="pagination pagination-sm mb-0" id="medicinePagination"></ul></nav>
                    <div class="small text-muted" id="medicinePageInfo"></div>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-pills fa-3x text-muted"></i>
                    </div>
                    <h5 class="text-muted">Henüz İlaç Eklenmemiş</h5>
                    <p class="text-muted">Sisteme ilk ilacınızı eklemek için aşağıdaki butona tıklayın.</p>
                    @if (userRole == "Admin" || userRole == "Doctor")
                    {
                        <a href="@Url.Action("Create")" class="btn btn-primary">
                            <i class="fas fa-plus"></i> İlk İlacı Ekle
                        </a>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning"></i> İlaç Silme Onayı
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bu ilacı silmek istediğinizden emin misiniz?</p>
                <div class="alert alert-warning">
                    <strong id="medicineNameToDelete"></strong> isimli ilaç kalıcı olarak silinecektir.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <form method="post" style="display: inline;" id="deleteForm">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Evet, Sil
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allMedicines = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Store original medicine data
            const rows = document.querySelectorAll('.medicine-row');
            allMedicines = Array.from(rows).map(row => ({
                element: row,
                name: row.getAttribute('data-name'),
                stock: parseInt(row.getAttribute('data-stock')),
                date: row.getAttribute('data-date')
            }));
            
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            const stockFilter = document.getElementById('stockFilter');
            const sortSelect = document.getElementById('sortSelect');
            
            searchInput.addEventListener('input', filterMedicines);
            stockFilter.addEventListener('change', filterMedicines);
            sortSelect.addEventListener('change', filterMedicines);
        });

        function filterMedicines() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const stockFilter = document.getElementById('stockFilter').value;
            const sortType = document.getElementById('sortSelect').value;
            
            let filteredMedicines = allMedicines.filter(medicine => {
                // Search filter
                const matchesSearch = medicine.name.includes(searchTerm);
                
                // Stock filter
                let matchesStock = true;
                if (stockFilter === 'normal') {
                    matchesStock = medicine.stock > 10;
                } else if (stockFilter === 'low') {
                    matchesStock = medicine.stock <= 10 && medicine.stock > 0;
                } else if (stockFilter === 'empty') {
                    matchesStock = medicine.stock === 0;
                }
                
                return matchesSearch && matchesStock;
            });
            
            // Sort medicines
            filteredMedicines.sort((a, b) => {
                switch(sortType) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'stock-asc':
                        return a.stock - b.stock;
                    case 'stock-desc':
                        return b.stock - a.stock;
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    default:
                        return 0;
                }
            });
            
            // Update table
            const tbody = document.querySelector('#medicinesTable tbody');
            tbody.innerHTML = '';
            
            // Pagination sabit 10
            const pageSize = 10; let current = 1;
            function renderPage(){
                tbody.innerHTML='';
                const total = filteredMedicines.length; const pages = Math.max(1, Math.ceil(total/pageSize));
                if(current>pages) current=pages;
                filteredMedicines.slice((current-1)*pageSize,current*pageSize).forEach(m=>tbody.appendChild(m.element));
                renderPagination(pages,total);
            }
            function renderPagination(pages,total){
                const pagUl = document.getElementById('medicinePagination');
                const info = document.getElementById('medicinePageInfo');
                if(!pagUl) return;
                pagUl.innerHTML='';
                if(pages>1){
                    const mk=(p,txt,dis,act)=>`<li class='page-item ${dis?'disabled':''} ${act?'active':''}'><a href='#' class='page-link' data-page='${p}'>${txt}</a></li>`;
                    pagUl.innerHTML += mk(current-1,'«',current===1,false);
                    let start=Math.max(1,current-2); let end=Math.min(pages,start+4); if(end-start<4) start=Math.max(1,end-4);
                    for(let p=start;p<=end;p++){ pagUl.innerHTML += mk(p,p,false,p===current);} 
                    pagUl.innerHTML += mk(current+1,'»',current===pages,false);
                    pagUl.addEventListener('click',function(e){ const a=e.target.closest('a[data-page]'); if(!a) return; e.preventDefault(); const p=parseInt(a.dataset.page); if(!isNaN(p)){ current=Math.max(1,p); renderPage(); } },{ once:true });
                }
                const startRecord = total?((current-1)*pageSize+1):0;
                const endRecord = Math.min(current*pageSize,total);
                info.textContent = `${startRecord}-${endRecord} / ${total}`;
                document.getElementById('totalCount').textContent = `${total} İlaç`;
            }
            renderPage();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('stockFilter').value = '';
            document.getElementById('sortSelect').value = 'name-asc';
            filterMedicines();
        }

        function confirmDelete(medicineId, medicineName) {
            document.getElementById('medicineNameToDelete').textContent = medicineName;
            document.getElementById('deleteForm').action = '@Url.Action("Delete")/' + medicineId;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        function exportToExcel() {
            // Simple CSV export
            const medicines = allMedicines.map(m => {
                const row = m.element;
                const cells = row.querySelectorAll('td');
                return {
                    name: cells[0].querySelector('h6').textContent,
                    description: cells[1].textContent.trim(),
                    stock: parseInt(cells[2].textContent.trim()),
                    createdAt: cells[3].textContent.replace(/\s+/g, ' ').trim()
                };
            });
            
            let csvContent = "İlaç Adı,Açıklama,Stok Miktarı,Eklenme Tarihi\n";
            medicines.forEach(medicine => {
                csvContent += `"${medicine.name}","${medicine.description}","${medicine.stock}","${medicine.createdAt}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ilaclar.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function useMedicine(medicineId, medicineName) {
            if (confirm(`${medicineName} isimli ilacı kullanmak istediğinizden emin misiniz?\n\nBu işlem ilacın stok miktarını 1 azaltacaktır.`)) {
                // AJAX call to use medicine
                fetch('@Url.Action("UseMedicine")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ medicineId: medicineId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showAlert('success', `${medicineName} başarıyla kullanıldı. Kalan stok: ${data.remainingStock}`);
                        
                        // Refresh page to update stock display
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showAlert('danger', data.message || 'İlaç kullanımında bir hata oluştu.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'İlaç kullanımında bir hata oluştu.');
                });
            }
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container-fluid');
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
    </script>

    <style>
        .bg-gradient-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }
        
        .bg-gradient-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }
        
        .bg-gradient-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0,123,255,0.05);
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .card {
            transition: all 0.3s ease;
        }
        
        .medicine-row {
            transition: all 0.3s ease;
        }
    </style>
}
